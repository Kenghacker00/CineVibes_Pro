{% extends "base.html" %}

{% block title %}{{ movie.title | default('Película Desconocida') }} ({{ movie.year | default('N/A') }}) - CineVibes{% endblock %}

{% block content %}
<div class="container-fluid animate__animated animate__fadeIn">
    <div class="row">
        <div class="col-12 col-lg-8 mb-4">
            <div class="movie-player p-4 rounded shadow">
                <h2 class="movie-title-player mb-3">{{ movie.title | default('Película Desconocida') }} ({{ movie.year | default('N/A') }})</h2>

                {% if movie.video_link %}
                <div class="embed-responsive embed-responsive-16by9" style="height: 500px;">
                    <iframe class="embed-responsive-item"
                        src="{{ movie.video_link }}"
                        sandbox="allow-same-origin allow-scripts allow-forms"
                        allowfullscreen
                        referrerpolicy="no-referrer"
                        style="width: 100%; height: 100%; border: 0;">
                    </iframe>
                </div>
                <div class="alert alert-info mt-3" role="alert">
                    Doble clic en el video para pantalla completa.
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> Lo sentimos, el video no está disponible en este momento.
                </div>
                {% endif %}
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div class="movie-info p-4 mb-4 rounded shadow">
                <h3 class="mb-3">Detalles de la Película</h3>
                <p><i class="fas fa-film"></i> <strong>Director:</strong> {{ movie.director | default('N/A') }}</p>
                <p><i class="fas fa-calendar-alt"></i> <strong>Año:</strong> {{ movie.year | default('N/A') }}</p>
                <p><i class="fas fa-star"></i> <strong>Calificación IMDb:</strong> {{ movie.imdb_rating if movie.imdb_rating != 'N/A' else 'N/A' }}</p>
                <p><i class="fas fa-clock"></i> <strong>Duración:</strong> {{ movie.runtime | default('N/A') }}</p>
                <p><i class="fas fa-language"></i> <strong>Idioma:</strong> {{ movie.language | default('N/A') }}</p>
                <p><i class="fas fa-globe"></i> <strong>País:</strong> {{ movie.country | default('N/A') }}</p>
                <p><i class="fas fa-trophy"></i> <strong>Premios:</strong> {{ movie.awards | default('N/A') }}</p>
                <h4 class="mt-4 mb-2">Sinopsis</h4>
                <p>{{ movie.plot | default('N/A') }}</p>
                <h4 class="mt-4 mb-2">Actores</h4>
                <p>{{ movie.actors | default('N/A') }}</p>
                <h4 class="mt-4 mb-2">Género</h4>
                <p>{{ movie.genre | default('N/A') }}</p>
            </div>
        </div>
    </div>

    <div class="comments-section p-4 rounded shadow mb-4">
        <h3>Comentarios</h3>
    <form id="comment-form" method="POST" action="{{ url_for('add_review', movie_id=movie.imdb_id) }}">
            <div class="form-group">
                <textarea class="form-control" name="content" rows="3" placeholder="Escribe tu comentario aquí..." required></textarea>
            </div>
            <div class="form-group">
                <label for="rating">Calificación:</label>
                <div class="star-rating">
                    <input type="radio" id="star5" name="rating" value="5" required /><label for="star5"></label>
                    <input type="radio" id="star4" name="rating" value="4" /><label for="star4"></label>
                    <input type="radio" id="star3" name="rating" value="3" /><label for="star3"></label>
                    <input type="radio" id="star2" name="rating" value="2" /><label for="star2"></label>
                    <input type="radio" id="star1" name="rating" value="1" /><label for="star1"></label>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Enviar Comentario</button>
        </form>

        <div class="comments-list mt-4">
            {% for review in reviews %}
                <div class="comment mb-4 p-2 border rounded" id="review-{{ review.id }}">
                    <div class="d-flex align-items-center justify-content-between">
                                                                        <div class="d-flex align-items-center comment-head">
                                                        <img loading="lazy" src="{{ profile_src(review.user_profile_pic) }}"
                                                                 alt="Foto de Perfil"
                                                                                         class="profile-img mr-2">
                                                                                <div class="d-flex flex-column flex-sm-row align-items-sm-center comment-meta">
                                                                                    <a href="{{ url_for('user_profile', user_id=review.user_id) }}" class="user-profile-link mr-sm-2">
                                                                    <strong class="comment-username">{{ review.user_nickname }}</strong>
                                                            </a>
                                                                                    <small class="comment-date">{{ review.created_at | fmt_dt }}</small>
                                                        </div>
                                                </div>
                        {% if user and user.id == review.user_id %}
                            <div>
                                <button class="btn btn-sm btn-outline-primary edit-review" data-review-id="{{ review.id }}">Editar</button>
                                <button class="btn btn-sm btn-outline-danger delete-review" data-review-id="{{ review.id }}">Eliminar</button>
                            </div>
                        {% endif %}
                    </div>
                    <p class="review-text mt-2">{{ review.review_text }}</p>
                    <p class="rating">Calificación:
                        {% for i in range(review.rating) %}
                            <i class="fas fa-star"></i>
                        {% endfor %}
                        {% for i in range(5 - review.rating) %}
                            <i class="far fa-star"></i>
                        {% endfor %}
                    </p>
                </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #1a1a1a;
        color: #ffffff;
    }

    .movie-player, .movie-info, .comments-section {
        background: rgba(255, 0, 0, 0.1);
        border-radius: 15px;
        transition: transform 0.3s, box-shadow 0.3s;
        border: 2px solid #ff0000;
    }

    .movie-player:hover, .movie-info:hover, .comments-section:hover {
        transform: none;
        box-shadow: 0 4px 20px rgba(255, 0, 0, 0.5);
    }

    .movie-title-player, h3, h4 {
        color: #ff0000;
    }

    .btn-primary {
        background-color: #ff0000;
        border: none;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        background-color: #cc0000;
        box-shadow: 0 0 15px #ff0000;
    }

    .form-control {
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 0, 0, 0.5);
        color: #ffffff;
    }

    .form-control:focus {
        background-color: rgba(255, 255, 255, 0.2);
        border-color: #ff0000;
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
    }

    .star-rating {
        display: inline-block;
        direction: rtl;
    }

    .star-rating input[type="radio"] {
        display: none;
    }

    .star-rating label {
        color: #bbb;
        font-size: 1.5em;
        padding: 0;
        cursor: pointer;
        transition: all .3s ease-in-out;
    }

    .star-rating label:before {
        content: "\2605";
    }

    .star-rating input[type="radio"]:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label {
        color: #f2b600;
    }

    .user-profile-link {
        color: #ff0000;
        text-decoration: none;
        transition: all 0.3s ease;
    }

    .user-profile-link:hover {
        color: #ff6666;
        text-shadow: 0 0 5px #ff0000;
    }

    .comment {
        background-color: rgba(255, 0, 0, 0.05);
        border-color: #ff0000;
        transition: all 0.3s ease;
    }

    .comment:hover {
        transform: none;
        box-shadow: 0 5px 15px rgba(255, 0, 0, 0.2);
    }

    .rating {
        color: #ffd700;
    }

    /* Avatar and text wrapping */
    .profile-img{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #ff0000;margin-right:22px}
    .comment-username{color:#ffffff;word-break:break-word}
    .review-text{white-space:pre-wrap;word-wrap:break-word;overflow-wrap:anywhere}
    .comment-date{color:#ffffff;opacity:.9}
    .comment-meta{gap:.8rem}

    @media (max-width: 768px) {
        .embed-responsive {
            height: 300px;
        }

        .btn {
            width: 100%;
            margin-bottom: 10px;
        }
    .comment-head{align-items:flex-start}
    .comment-meta{gap:.8rem}
    .comment-date{margin-top:2px;display:block}
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
        // Handle add review (AJAX)
        const commentForm = document.getElementById('comment-form');
        if (commentForm) {
            commentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(commentForm);
                const res = await fetch(commentForm.action, {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    body: formData
                });
                if (!res.ok) return alert('Error al enviar el comentario');
                const data = await res.json();
                if (!data.success) return alert(data.message || 'Error');
                const list = document.querySelector('.comments-list');
                if (list && data.html) {
                    list.insertAdjacentHTML('afterbegin', data.html);
                    commentForm.reset();
                    attachRowHandlers(list.firstElementChild);
                }
            });
        }

    // Edit/Delete listeners are bound via attachRowHandlers()

    // Handle edit form submission
    document.addEventListener('submit', async function(e) {
        if (e.target.classList.contains('edit-review-form')) {
            e.preventDefault();
            const reviewId = e.target.getAttribute('data-review-id');
            const formData = new FormData(e.target);
            const res = await fetch(`/review/${reviewId}`, {
                method: 'PUT',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                body: formData
            });
            const data = await res.json();
            if (data.success && data.html) {
                const el = document.getElementById(`review-${reviewId}`);
                if (el) {
                  el.outerHTML = data.html;
                  const replaced = document.getElementById(`review-${reviewId}`);
                  attachRowHandlers(replaced);
                }
            } else {
                alert(data.message || 'Error al actualizar el comentario');
            }
        }
    });

    // Handle cancel edit
        document.addEventListener('click', function(e) {
        if (e.target.classList.contains('cancel-edit')) {
                        const form = e.target.closest('.edit-review-form');
                        if (!form) return;
                        const id = form.getAttribute('data-review-id');
                        const container = document.getElementById(`review-${id}`);
                        if (container?.dataset.originalHtml) {
                            container.innerHTML = container.dataset.originalHtml;
                            delete container.dataset.originalHtml;
                            attachRowHandlers(container);
                        }
        }
    });

        function attachRowHandlers(scope){
            const root = scope||document;
            root.querySelectorAll('.edit-review').forEach(btn=>{
                if (!btn.dataset.bound) {
                    btn.dataset.bound = '1';
                    btn.addEventListener('click', function(){
                        const reviewId = this.getAttribute('data-review-id');
                        const reviewElement = document.getElementById(`review-${reviewId}`);
                        const reviewText = reviewElement.querySelector('.review-text').textContent;
                        const rating = reviewElement.querySelectorAll('i.fas.fa-star').length;
                        const formHtml = `
                            <form class="edit-review-form" data-review-id="${reviewId}">
                                <textarea class="form-control mb-2" name="content" rows="3" required>${reviewText}</textarea>
                                <div class="form-group">
                                    <label for="rating">Calificación:</label>
                                    <div class="star-rating">
                                        <input type="radio" id="star5-edit-${reviewId}" name="rating" value="5" ${rating === 5 ? 'checked' : ''} required /><label for="star5-edit-${reviewId}"></label>
                                        <input type="radio" id="star4-edit-${reviewId}" name="rating" value="4" ${rating === 4 ? 'checked' : ''} /><label for="star4-edit-${reviewId}"></label>
                                        <input type="radio" id="star3-edit-${reviewId}" name="rating" value="3" ${rating === 3 ? 'checked' : ''} /><label for="star3-edit-${reviewId}"></label>
                                        <input type="radio" id="star2-edit-${reviewId}" name="rating" value="2" ${rating === 2 ? 'checked' : ''} /><label for="star2-edit-${reviewId}"></label>
                                        <input type="radio" id="star1-edit-${reviewId}" name="rating" value="1" ${rating === 1 ? 'checked' : ''} /><label for="star1-edit-${reviewId}"></label>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Guardar</button>
                                <button type="button" class="btn btn-secondary cancel-edit">Cancelar</button>
                            </form>`;
                        reviewElement.dataset.originalHtml = reviewElement.innerHTML;
                        reviewElement.innerHTML = formHtml;
                    });
                }
            });
            root.querySelectorAll('.delete-review').forEach(btn=>{
                if (!btn.dataset.bound) {
                    btn.dataset.bound = '1';
                    btn.addEventListener('click', function(){
                        if (!confirm('¿Estás seguro de que quieres eliminar este comentario?')) return;
                        const reviewId = this.getAttribute('data-review-id');
                        fetch(`/review/${reviewId}`, { method: 'DELETE', headers: { 'X-Requested-With': 'XMLHttpRequest', 'Content-Type':'application/json' } })
                            .then(r=>r.json()).then(data=>{ if (data.success) document.getElementById(`review-${reviewId}`)?.remove(); else alert('Error al eliminar'); });
                    });
                }
            });
        }
        // Bind initial rows
        attachRowHandlers();
});
</script>
{% endblock %}
