{% extends "base.html" %}

{% block title %}CineVibes - Perfil de {{ user.nickname }}{% endblock %}

{% block content %}
<div class="container animate__animated animate__fadeIn">
  <div class="row">
    <div class="col-md-4">
      <div class="profile-card glass-effect p-4 rounded">
        <div class="profile-header text-center">
          <img loading="lazy" src="{{ user.profile_pic if user.profile_pic and user.profile_pic.startswith('http') else (url_for('static', filename=user.profile_pic) if user.profile_pic else url_for('static', filename='images/default_profile.png')) }}"
               alt="Foto de perfil"
               class="profile-image animate__animated animate__fadeIn">
          <div class="profile-status">
            <span class="status-badge {% if user.is_verified %}verified{% else %}unverified{% endif %}">
              <i class="fas {% if user.is_verified %}fa-check-circle{% else %}fa-times-circle{% endif %}"></i>
              {% if user.is_verified %}Verificado{% else %}No verificado{% endif %}
            </span>
          </div>
        </div>

        <div class="profile-info text-center">
          <h2 class="profile-name">{{ user.nickname }}</h2>
          <p class="profile-email"><i class="fas fa-envelope"></i> {{ user.email }}</p>
          <p class="profile-reviews">
            <i class="fas fa-star"></i> {{ review_count }} reseña{% if review_count != 1 %}s{% endif %}
          </p>

          <form action="{{ url_for('profile') }}" method="POST" enctype="multipart/form-data" class="mt-3">
            {{ form.hidden_tag() }}
            <div class="form-group">
              <label for="profile_pic" class="btn btn-outline-light btn-upload">
                <i class="fas fa-camera"></i> Cambiar foto
              </label>
              {{ form.profile_pic(
                   id="profile_pic",
                   class="form-control-file d-none",
                   accept=".jpg,.jpeg,.png,image/*"
              ) }}
              <small class="text-muted d-block mt-2">Máx. 2 MB. Formatos: JPG/PNG.</small>
              <div id="upload-error" class="alert alert-danger mt-2 d-none"></div>
            </div>
          </form>



          <a href="{{ url_for('edit_profile') }}" class="btn btn-danger mt-3 led-effect">
            <i class="fas fa-edit"></i> Editar Perfil
          </a>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="reviews-section glass-effect p-4 rounded">
        <h3 class="section-title">
          <i class="fas fa-star"></i> Mis Reseñas ({{ review_count }})
        </h3>

        {% if reviews %}
          <div class="reviews-list row">
            {% for review in reviews %}
              <div class="col-12 col-md-6 mb-4">
                <div class="review-card animate__animated animate__fadeIn h-100">
                  <div class="review-header">
                    <div class="d-flex align-items-center">
                      <img loading="lazy" src="{{ review.movie_poster }}" alt="{{ review.movie_title }}" class="movie-poster mr-3" style="width: 50px; height: auto;">
                      <h4><a href="{{ url_for('movie_player', movie_id=review.imdb_id) }}">{{ review.movie_title }}</a></h4>
                    </div>
                    <div class="rating">
                      {% for i in range(review.rating|int) %}<i class="fas fa-star"></i>{% endfor %}
                      {% for i in range(5 - review.rating|int) %}<i class="far fa-star"></i>{% endfor %}
                    </div>
                  </div>
                  <p class="review-text">{{ review.review_text }}</p>
                  <div class="review-footer">
                    <small class="review-date"><i class="far fa-clock"></i> {{ review.created_at }}</small>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="no-reviews">
            <i class="fas fa-film fa-3x"></i>
            <p>Aún no has escrito reseñas</p>
            <a href="{{ url_for('search') }}" class="btn btn-danger led-effect">
              <i class="fas fa-plus"></i> Buscar peliculas
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
body { background-color:#1a1a1a; color:#fff; }
.glass-effect { background:rgba(255,0,0,.1); backdrop-filter:blur(10px); border-radius:15px; transition:.3s; border:2px solid #f00; }
.glass-effect:hover { transform:scale(1.02); box-shadow:0 0 20px rgba(255,0,0,.5); }
.profile-image { width:150px; height:150px; object-fit:cover; border-radius:50%; border:3px solid #f00; box-shadow:0 0 20px rgba(255,0,0,.2); margin-bottom:20px; transition:.3s; }
.profile-image:hover { transform:scale(1.05); }
.status-badge { display:inline-block; padding:5px 15px; border-radius:20px; font-size:.9rem; margin:10px 0; }
.status-badge.verified { background:rgba(40,167,69,.2); color:#28a745; }
.status-badge.unverified { background:rgba(220,53,69,.2); color:#dc3545; }
.btn-upload { border:2px solid #fff; transition:.3s; }
.btn-upload:hover { background:#fff; color:#f00; }
.btn-danger { background:#f00; border:none; transition:.3s; }
.btn-danger:hover { background:#c00; transform:scale(1.05); }
.led-effect { box-shadow:0 0 10px #f00; transition:.3s; }
.led-effect:hover { box-shadow:0 0 20px #f00, 0 0 40px #f00; }
.section-title { color:#fff; margin-bottom:25px; border-bottom:2px solid #f00; padding-bottom:10px; }
.review-card { background:rgba(255,0,0,.1); border-radius:10px; padding:20px; margin-bottom:20px; transition:.3s; }
.review-card:hover { transform:translateY(-5px); box-shadow:0 5px 15px rgba(255,0,0,.2); }
.review-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.movie-poster { width:50px; height:75px; object-fit:cover; border-radius:5px; margin-right:10px; box-shadow:0 2px 4px rgba(255,0,0,.1); }
.rating { color:#ffd700; }
.no-reviews { text-align:center; padding:40px 0; color:#fff; opacity:.7; }
@media (max-width:768px){
  .container{ padding:10px; }
  .profile-card,.reviews-section{ margin-bottom:20px; }
  .review-card{ padding:15px; }
  .movie-poster{ width:40px; height:60px; }
}
.pagination .page-link{ background-color:rgba(255,0,0,.1); border-color:#f00; color:#fff; }
.pagination .page-item.active .page-link{ background-color:#f00; border-color:#f00; }
.pagination .page-link:hover{ background-color:rgba(255,0,0,.3); }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const input = document.getElementById('profile_pic');
  const preview = document.querySelector('.profile-image');
  const errorBox = document.getElementById('upload-error');
  const form = input?.form;

  const ALLOWED = ['image/jpeg', 'image/png'];
  const MAX_BYTES = 2 * 1024 * 1024; // 2 MB

  function showError(msg){
    if(!errorBox) return;
    errorBox.textContent = msg;
    errorBox.classList.remove('d-none');
  }
  function hideError(){
    if(!errorBox) return;
    errorBox.textContent = '';
    errorBox.classList.add('d-none');
  }

  if (input) {
    input.addEventListener('change', function () {
      hideError();
      if (!this.files || !this.files[0]) return;
      const file = this.files[0];

      if (!ALLOWED.includes(file.type)) {
        showError('Formato no permitido. Solo imágenes JPG/PNG.');
        this.value = '';
        return;
      }
      if (file.size > MAX_BYTES) {
        showError('El archivo es demasiado grande. Máximo 2 MB.');
        this.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = e => { preview.src = e.target.result; };
      reader.readAsDataURL(file);

      preview.style.opacity = '0.5';
      document.querySelector('#loading')?.remove();
      const loading = document.createElement('div');
      loading.id = 'loading';
      loading.textContent = 'Subiendo...';
      loading.className = 'mt-2 text-muted';
      document.querySelector('.profile-card').appendChild(loading);

      form.submit(); // enviar UNA sola vez
    });
  }
});
</script>
{% endblock %}